var t;

t = t || {};

$(document).ready(function() {
  t.char_counter();
  t.xhr();
  t.timeline_poller();
  return true;
});
t.timeline = function() {
  return true;
};
t.run_timeline_xhr = true;

t.timeline_xhr = function() {
  var $timeline, xhr_url;
  $timeline = $('.timeline');
  xhr_url = $timeline.data('xhr-url');
  t.timeline_newest = $('li:first .created_at', $timeline).data('created_at');
  if (xhr_url) {
    if (xhr_url.indexOf('?') > -1) {
      xhr_url += '&since=' + t.timeline_newest;
    } else {
      xhr_url += '?since=' + t.timeline_newest;
    }
    if (window.location.href.indexOf('/fc') > -1) {
      t.run_timeline_xhr = false;
    }
    if (t.run_timeline_xhr) {
      t.run_timeline_xhr = false;
      return $.get(xhr_url, function(data) {
        if (data.length > 1) {
          $timeline.prepend(data);
        }
        return t.run_timeline_xhr = true;
      });
    }
  }
};

t.timeline_poller = function() {
  return setInterval(function() {
    return t.timeline_xhr();
  }, 2000);
};
t.char_counter = function() {
  var $charcounter, $telegram, $transmit;
  $telegram = $('#telegram');
  $transmit = $('#transmit');
  $charcounter = $('.charcounter');
  return $telegram.on('keyup', function() {
    var available_chars, remaining_chars, str_len;
    available_chars = 256;
    str_len = $telegram.val().length;
    remaining_chars = available_chars - str_len;
    $charcounter.text(remaining_chars);
    if (remaining_chars < 0) {
      $charcounter.addClass('warning');
      return $transmit.attr('disabled', 'disabled');
    } else {
      $charcounter.removeClass('warning');
      return $transmit.attr('disabled', false);
    }
  });
};
t.run_xhr = true;

t.xhr_step = 10;

t.xhr_load = function() {
  var $xhr, xhr_url;
  $xhr = $('.xhr');
  xhr_url = $xhr.data('xhr-url');
  if (xhr_url) {
    if (xhr_url.indexOf('?') > -1) {
      xhr_url += '&step=' + t.xhr_step;
    } else {
      xhr_url += '?step=' + t.xhr_step;
    }
    if (t.run_xhr) {
      t.run_xhr = false;
      return $.get(xhr_url, function(data) {
        if (data.length > 1) {
          $xhr.append(data);
          t.xhr_step = t.xhr_step + 10;
          return t.run_xhr = true;
        } else {
          return t.run_xhr = false;
        }
      });
    }
  }
};

t.scroll_action = function() {
  var bottom_distance, d_height, scroll_to, w_height;
  d_height = $(document).height();
  w_height = $(window).height();
  scroll_to = $(window).scrollTop();
  bottom_distance = d_height - w_height - scroll_to;
  if (bottom_distance < 100) {
    return t.xhr_load();
  }
};

t.xhr = function() {
  return setInterval(function() {
    return t.scroll_action();
  }, 100);
};
